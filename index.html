<!DOCTYPE html>
<html>
	<head>
		<title>Demo: GBKN data in browser, fully client side</title>

		<!-- jQuery -->
		<script type="text/javascript" src="http://code.jquery.com/jquery-1.7.1.min.js"></script>

		<!-- OpenLayers -->
		<script type="text/javascript" src="http://openlayers.org/api/2.11/OpenLayers.js"></script>

		<!-- NEN and geometry related -->
		<script type="text/javascript" src="js/straightcurve-0.0.2.js"></script>
		<script type="text/javascript" src="js/nen1878reader-0.6.1.js"></script>

		<!-- Other geometries -->
		<script type="text/wkt" id="bounds_netherlands">
			POLYGON((141000000 629000000, 100000000 600000000, 80000000  500000000, -7000000  392000000, -7000000  336000000, 101000000 336000000, 161000000 289000000, 219000000 289000000, 300000000 451000000, 300000000 614000000, 259000000 629000000, 141000000 629000000))
		</script>
	</head>

	<body>
		<div id="map" style="width: 400px; height: 300px; border: 1px solid;">
		</div>

		<script type="text/javascript">
			var olMap;
			var olLayer;
			var olZoom = 5;
			var olGeoJsonFormat = new OpenLayers.Format.GeoJSON();
			var olNenLayer;

			// OpenLayers thingies
			function setupMap() {
				olMap = new OpenLayers.Map('map', {
					maxExtent: new OpenLayers.Bounds(-7000000, 289000000, 300000000, 629000000),
					maxResolution: 250000 / 256, // 250m per 256px
					units: 'mm',
					projection: "EPSG:28992"
				});

				// add NEN-layer
				olNenLayer = new OpenLayers.Layer.Vector();
				olMap.addLayer(olNenLayer);
				olMap.setBaseLayer(olNenLayer);

				// center
				var featureCenter = new OpenLayers.LonLat(131006460, 480027748);
				olMap.setCenter(featureCenter, olZoom);
			}

			// NEN/GBKN thingies
			// styles taken from the GBKN handboek 2.1
			var nenStyles = {
				'B01': { strokeColor: '#ff0000' },
				'B02': { strokeColor: '#ff0000' },
				'B07': { strokeColor: '#ff0000' },
				'B11': { strokeColor: '#ff0000' },
				'B14': { strokeColor: '#ff0000' },

				'B17': { strokeColor: '#ff0000', strokeDashstyle: 'point' },
				'B20': { strokeColor: '#ff0000', strokeDashstyle: 'point' },

				'B03': { strokeColor: '#ff0000' },
				'B04': { strokeColor: '#ff0000' },

				'V00': { strokeColor: '#000000' },
				'V06': { strokeColor: '#000000' },

				'Q07': { strokeColor: '#0000ff' },
				'Q06': { strokeColor: '#0000ff' },

				'T00': { strokeColor: '#000000' },
				'T01': { strokeColor: '#000000' },
				'T13': { strokeColor: '#000000' },
				'T22': { strokeColor: '#000000' },
				'Q01': { strokeColor: '#000000' },
				'Q10': { strokeColor: '#000000' },
				'L01': { strokeColor: '#000000' },
			};
			function readNenFeatures() {
				function onNenRecord(record) {
					var nenFeature = nen1878reader.GeoJson.toFeature(record);

					if (record.recordType == 3) {
						var olFeature = olGeoJsonFormat.read(nenFeature, 'Feature');

						// color
						if (nenFeature.properties.lkiCode && nenFeature.properties.lkiCode in nenStyles) {
							var nenStyle = nenStyles[nenFeature.properties.lkiCode];
							olFeature.style = nenStyle;
						}

						olNenLayer.addFeatures(olFeature);
					}
				}

				function onNenEnd() {
					console.log('on nen end');
				}

				function onAjaxSuccess(data, textStatus, jqXHR) {
					var parser = new nen1878reader.Nen1878Parser();
					var reader = new nen1878reader.Nen1878StringReader(parser, data);

					parser.on('record', onNenRecord);
					reader.on('end', onNenEnd);

					reader.start();
				}

				function onAjaxError(jqXHR, textStatus, errorThrown) {
					console.log('error');
					console.log(textStatus);
				}

				$.ajax({
					url: 'data/WEESP_N__7001.NEN',
					dataType: 'text',
					success: onAjaxSuccess,
					error: onAjaxError
				});
			}

			$(document).ready(function() {
				setupMap();
				readNenFeatures();
			});
		</script>
	</body>
</html>
