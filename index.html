<!DOCTYPE html>
<html>
	<head>
		<title>Demo: GBKN data in browser, fully client side</title>

		<!-- jQuery -->
		<script type="text/javascript" src="http://code.jquery.com/jquery-1.7.1.min.js"></script>

		<!-- OpenLayers -->
		<script type="text/javascript" src="http://openlayers.org/api/2.11/OpenLayers.js"></script>

		<!-- NEN and geometry related -->
		<script type="text/javascript" src="js/straightcurve-0.0.2.js"></script>
		<script type="text/javascript" src="js/nen1878reader-0.6.1.js"></script>

		<!-- Style map, styles taken from the GBKN handboek 2.1 -->
		<script id="gbkn_style" type="text/json">
			{
				"B01": { "strokeColor": "#ff0000" },
				"B02": { "strokeColor": "#ff0000" },
				"B07": { "strokeColor": "#ff0000" },
				"B11": { "strokeColor": "#ff0000" },
				"B14": { "strokeColor": "#ff0000" },
				"B17": { "strokeColor": "#ff0000"," strokeDashstyle": "point" },
				"B20": { "strokeColor": "#ff0000", "strokeDashstyle": "point" },

				"B03": { "strokeColor": "#ff0000" },
				"B04": { "strokeColor": "#ff0000" },

				"V00": { "strokeColor": "#000000" },
				"V06": { "strokeColor": "#000000" },

				"Q07": { "strokeColor": "#0000ff" },
				"Q06": { "strokeColor": "#0000ff" },
				"W00": { "strokeColor": "#0000ff" },
				"T09": { "strokeColor": "#0000ff" },
				"T07": { "strokeColor": "#0000ff" },

				"T00": { "strokeColor": "#000000" },
				"T01": { "strokeColor": "#000000" },
				"T13": { "strokeColor": "#000000" },
				"T22": { "strokeColor": "#000000" },
				"Q01": { "strokeColor": "#000000" },
				"Q10": { "strokeColor": "#000000" },
				"L01": { "strokeColor": "#000000" },

				"Z06": { "fontColor": "#000000", "fontFamily": "Arial", "label": "${text}" },
				"Z02": { "fontColor": "#000000", "fontFamily": "Arial", "label": "${text}" },

				"Z07": { "fontColor": "#0000ff", "fontFamily": "Arial", "label": "${text}" },

				"Z09": { "fontColor": "#000000", "fontFamily": "Arial", "label": "${text}" },
				"Z05": { "fontColor": "#000000", "fontFamily": "Arial", "label": "${text}" },
				"Z19": { "fontColor": "#000000", "fontFamily": "Arial", "label": "${text}" }
			}
		</script>

		<!-- Visibility rules for Street names and House numbers -->
		<script id="visibility_rules" type="text/json">
			{
				"Z06": [ { "maxScaleDenominator": 2000 } ],
				"Z02": [ { "maxScaleDenominator": 1000 } ]
			}
		</script>
	</head>

	<body>
		<div id="map" style="width: 600px; height: 450px; border: 1px solid;">
		</div>

		<script type="text/javascript">
			var olMap;
			var olLayers = {};
			var olCenter = new OpenLayers.LonLat(131006460, 480027748);
			var olZoom = 3;

			// OpenLayers thingies
			function setupMap() {
				olMap = new OpenLayers.Map('map', {
					maxExtent: new OpenLayers.Bounds(-7000000, 289000000, 300000000, 629000000),
					maxResolution: 500000 / 256, // 500m per 256px
					units: 'mm',
					projection: "EPSG:28992"
				});

				// add base layer
				var baseLayer = getLayer('base');
				olMap.addLayer(baseLayer);
				olMap.setBaseLayer(baseLayer);

				// center
				olMap.setCenter(olCenter, olZoom);
			}

			var nenStyles = JSON.parse($('#gbkn_style').text());
			var nenVisibilities = JSON.parse($('#visibility_rules').text());
			function getLayer(lkiCode) {
				if (lkiCode && !(lkiCode in olLayers)) {
					// visibility rules
					var rules = [];
					if (nenVisibilities[lkiCode]) {
						for (var i = 0; i < nenVisibilities[lkiCode].length; ++i) {
							var definition = nenVisibilities[lkiCode][i];
							var rule = new OpenLayers.Rule(definition);
							rules.push(rule);
						}
					}

					// style for layer
					var nenStyle = nenStyles[lkiCode];
					var style = new OpenLayers.Style(nenStyle, {
						rules: rules
					});

					// create layer
					var layer = new OpenLayers.Layer.Vector(lkiCode, {
						styleMap: new OpenLayers.StyleMap(style)
					});
					olMap.addLayer(layer);

					olLayers[lkiCode] = layer;
				}

				return olLayers[lkiCode];
			}


			// NEN/GBKN thingies
			function readNenFeatures() {
				var olGeoJsonFormat = new OpenLayers.Format.GeoJSON();

				function arcToLineString(arc) {
					// convert an arc to a line string
					var points = [
						new straightcurve.Vertex2(arc.coordinates[0].x, arc.coordinates[0].y),
						new straightcurve.Vertex2(arc.coordinates[1].x, arc.coordinates[1].y),
						new straightcurve.Vertex2(arc.coordinates[2].x, arc.coordinates[2].y),
					];
					var arc = new straightcurve.Arc2(points[0], points[1], points[2]);
					var lines = arc.segmentize(25);
					var geometry = {
						type: 'LineString',
						coordinates: []
					}
					geometry.coordinates.push([ lines[0].p0.x, lines[0].p0.y ]);
					for (var i = 0; i < lines.length; ++i) {
						var line = lines[i];
						geometry.coordinates.push([ line.p1.x, line.p1.y ]);
					}
					return geometry;
				}

				function onNenRecord(record) {
					var nenFeature = nen1878reader.GeoJson.toFeature(record);

					// only add records of type 3 or 5
					if (record.recordType != 3 && record.recordType != 5) {
						return;
					}

					// 
					if (record.geometryType == 13) {
						nenFeature.geometry = arcToLineString(record.geometry);
					}

					var olFeature = olGeoJsonFormat.read(nenFeature, 'Feature');
					var layer = getLayer(record.lkiCode);

					layer.addFeatures(olFeature);
				}

				function onAjaxSuccess(data, textStatus, jqXHR) {
					var parser = new nen1878reader.Nen1878Parser();
					var reader = new nen1878reader.Nen1878StringReader(parser, data);

					parser.on('record', onNenRecord);

					reader.start();
				}

				function onAjaxError(jqXHR, textStatus, errorThrown) {
					console.log('ajax error');
					console.log(textStatus);
				}

				$.ajax({
					url: 'data/WEESP_N__7001.NEN',
					dataType: 'text',
					success: onAjaxSuccess,
					error: onAjaxError
				});
			}

			$(document).ready(function() {
				setupMap();
				readNenFeatures();
			});
		</script>
	</body>
</html>
